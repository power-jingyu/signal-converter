<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Scale 신호 변환기</title>
    
    <!-- Tailwind CSS (스타일링) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UI 라이브러리) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX 변환기) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 커스텀 애니메이션 설정 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 아이콘 컴포넌트 (Lucide 아이콘 대체용 SVG) ---
        const IconSettings = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const IconRefreshCw = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M8 16H3v5"></path>
            </svg>
        );

        const IconCalculator = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="16" height="20" x="4" y="2" rx="2"></rect>
                <line x1="8" x2="16" y1="6" y2="6"></line>
                <line x1="16" x2="16" y1="14" y2="18"></line>
                <path d="M16 10h.01"></path>
                <path d="M12 10h.01"></path>
                <path d="M8 10h.01"></path>
                <path d="M12 14h.01"></path>
                <path d="M8 14h.01"></path>
                <path d="M12 18h.01"></path>
                <path d="M8 18h.01"></path>
            </svg>
        );

        const IconInfo = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
            </svg>
        );

        // --- 메인 애플리케이션 컴포넌트 ---
        const AutoScaleCalculator = () => {
            // --- 상태 관리 (State Management) ---
            const [inputs, setInputs] = useState({
                min: 0,
                max: 100,
                angle: 235, // 기본값 235도
                density: 'normal' // low, normal, high
            });

            const [result, setResult] = useState({
                step: 0,
                ticks: 0,
                data: []
            });

            const [calculated, setCalculated] = useState(false);

            // --- 비즈니스 로직 (Business Logic) ---

            // 4-20mA 변환 함수
            const convertToMa = (value, min, max) => {
                if (max - min === 0) return 0;
                const ma = 4 + ((value - min) / (max - min)) * 16;
                return ma;
            };

            // 소수점 자릿수 계산
            const getPrecision = (step) => {
                if (step === 0) return 0;
                const str = step.toString();
                if (str.includes('.')) {
                    return str.split('.')[1].length;
                }
                return 0;
            };

            // 핵심 로직: 최적 간격 계산 (Nice Step Calculation)
            const calculateOptimalStep = (min, max, angle, densityType) => {
                const range = Math.abs(max - min);
                if (range === 0) return 0;

                // 1. 밀도에 따른 눈금 하나당 권장 각도 설정
                let degreePerTick;
                if (densityType === 'low') degreePerTick = 40;      // 여유롭게
                else if (densityType === 'high') degreePerTick = 15; // 촘촘하게
                else degreePerTick = 25;                            // 보통

                // 2. 목표 눈금 개수 계산
                const targetTickCount = angle / degreePerTick;
                if (targetTickCount === 0) return range;

                // 3. 가계산 간격 (Raw Step)
                const rawStep = range / targetTickCount;

                // 4. Nice Number (1-2-5 Rule) 적용
                const magnitude = Math.pow(10, Math.floor(Math.log10(rawStep)));
                const fraction = rawStep / magnitude;

                let niceFraction;
                if (fraction <= 1.5) niceFraction = 1;      // 설계서 로직: <= 1.5 -> 1
                else if (fraction <= 3.0) niceFraction = 2; // 설계서 로직: <= 3.0 -> 2
                else if (fraction <= 7.0) niceFraction = 5; // 설계서 로직: <= 7.0 -> 5
                else niceFraction = 10;                     // 그 외 -> 10

                // 최종 계산된 간격
                const niceStep = niceFraction * magnitude;
                return niceStep;
            };

            // 계산 실행 함수
            const handleCalculate = () => {
                const min = parseFloat(inputs.min);
                const max = parseFloat(inputs.max);
                const angle = parseFloat(inputs.angle);

                if (isNaN(min) || isNaN(max) || isNaN(angle)) {
                    alert("모든 값을 올바르게 입력해주세요.");
                    return;
                }
                if (min >= max) {
                    alert("최대값(Max)은 최소값(Min)보다 커야 합니다.");
                    return;
                }

                // 1. 최적 Step 계산
                const niceStep = calculateOptimalStep(min, max, angle, inputs.density);
                const precision = getPrecision(niceStep);

                // 2. 데이터 테이블 생성
                let currentVal = min;
                const tableData = [];
                
                // 무한 루프 방지용 안전 장치
                let safetyCounter = 0;
                const safetyLimit = 1000;

                while (currentVal < max && safetyCounter < safetyLimit) {
                    const fixedVal = parseFloat(currentVal.toFixed(precision));
                    
                    if (fixedVal > max) break;

                    tableData.push({
                        value: fixedVal,
                        ma: convertToMa(fixedVal, min, max).toFixed(3),
                        percent: ((fixedVal - min) / (max - min) * 100).toFixed(1)
                    });

                    currentVal += niceStep;
                    safetyCounter++;
                }

                // 3. 종료 처리 (Clamping)
                const lastVal = tableData.length > 0 ? tableData[tableData.length - 1].value : -9999;
                
                if (lastVal < max) {
                    tableData.push({
                        value: max,
                        ma: '20.000',
                        percent: '100.0',
                        isClamped: true
                    });
                } else if (lastVal > max) {
                    tableData[tableData.length - 1] = {
                        value: max,
                        ma: '20.000',
                        percent: '100.0',
                        isClamped: true
                    };
                }

                setResult({
                    step: niceStep,
                    ticks: tableData.length,
                    data: tableData
                });
                setCalculated(true);
            };

            // 입력 변경 핸들러
            const handleChange = (e) => {
                const { name, value } = e.target;
                setInputs(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            // 초기 실행
            useEffect(() => {
                handleCalculate();
            }, []);

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8">
                    <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
                        
                        {/* Header */}
                        <div className="bg-slate-900 text-white p-6 flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <IconCalculator className="w-6 h-6 text-blue-400" />
                                    Auto-Scale Signal Converter
                                </h1>
                                <p className="text-slate-400 text-sm mt-1">
                                    4~20mA 신호 변환 및 지시계 눈금 자동 설계
                                </p>
                            </div>
                            <div className="hidden md:block text-right text-xs text-slate-500">
                                Design Ver 2.0<br/>Nice Number Algorithm
                            </div>
                        </div>

                        <div className="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            {/* Left Panel: Inputs */}
                            <div className="lg:col-span-1 space-y-6">
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <h2 className="font-semibold text-lg mb-4 flex items-center gap-2 text-slate-700">
                                        <IconSettings className="w-5 h-5" />
                                        설정 (Input)
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        {/* Min */}
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">출력 최소값 (Min / 0%)</label>
                                            <input
                                                type="number"
                                                name="min"
                                                value={inputs.min}
                                                onChange={handleChange}
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                            />
                                        </div>

                                        {/* Max */}
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">출력 최대값 (Max / 100%)</label>
                                            <input
                                                type="number"
                                                name="max"
                                                value={inputs.max}
                                                onChange={handleChange}
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                            />
                                        </div>

                                        {/* Angle */}
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">게이지 운용 각도 (Angle)</label>
                                            <select
                                                name="angle"
                                                value={inputs.angle}
                                                onChange={handleChange}
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white"
                                            >
                                                <option value="90">90°</option>
                                                <option value="235">235°</option>
                                            </select>
                                            <p className="text-xs text-slate-400 mt-1">지시계 바늘이 움직이는 총 각도</p>
                                        </div>

                                        {/* Density */}
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">눈금 밀도 (Density)</label>
                                            <select
                                                name="density"
                                                value={inputs.density}
                                                onChange={handleChange}
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white"
                                            >
                                                <option value="low">여유롭게 (Low - 대형)</option>
                                                <option value="normal">보통 (Normal - 표준)</option>
                                                <option value="high">촘촘하게 (High - 정밀)</option>
                                            </select>
                                        </div>

                                        <button
                                            onClick={handleCalculate}
                                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex justify-center items-center gap-2 mt-4"
                                        >
                                            <IconRefreshCw className="w-5 h-5" />
                                            자동 계산 실행
                                        </button>
                                    </div>
                                </div>

                                {/* Guide Box */}
                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-sm text-yellow-800">
                                    <div className="flex items-start gap-2">
                                        <IconInfo className="w-5 h-5 shrink-0 mt-0.5" />
                                        <div>
                                            <strong>Auto-Scale 적용됨</strong>
                                            <p className="mt-1 text-xs opacity-90">
                                                더 이상 간격(Step)을 직접 입력하지 않습니다. 각도와 밀도를 입력하면 'Nice Number(1-2-5)' 규칙에 따라 최적의 눈금을 자동으로 제안합니다.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Right Panel: Output */}
                            <div className="lg:col-span-2">
                                {calculated ? (
                                    <div className="animate-fade-in-up">
                                        {/* Summary Cards */}
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                                <div className="text-xs text-blue-600 font-bold uppercase mb-1">최적 계산 간격 (Step)</div>
                                                <div className="text-3xl font-bold text-slate-800">{result.step}</div>
                                            </div>
                                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                                <div className="text-xs text-indigo-600 font-bold uppercase mb-1">총 눈금 수</div>
                                                <div className="text-3xl font-bold text-slate-800">{result.ticks} <span className="text-sm font-normal text-slate-500">ea</span></div>
                                            </div>
                                            <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100 col-span-2 md:col-span-1">
                                                <div className="text-xs text-emerald-600 font-bold uppercase mb-1">계측 범위 (Span)</div>
                                                <div className="text-3xl font-bold text-slate-800">{inputs.max - inputs.min}</div>
                                            </div>
                                        </div>

                                        {/* Result Table */}
                                        <div className="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-left border-collapse">
                                                    <thead>
                                                        <tr className="bg-slate-100 text-slate-600 text-xs uppercase tracking-wider border-b border-slate-200">
                                                            <th className="p-4 font-bold">No.</th>
                                                            <th className="p-4 font-bold text-blue-700">지시값 (Value)</th>
                                                            <th className="p-4 font-bold text-emerald-700">전류 (mA)</th>
                                                            <th className="p-4 font-bold">비율 (%)</th>
                                                            <th className="p-4 font-bold text-slate-400">비고</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="text-sm divide-y divide-slate-100">
                                                        {result.data.map((row, index) => (
                                                            <tr 
                                                                key={index} 
                                                                className={`hover:bg-slate-50 transition ${row.isClamped ? 'bg-yellow-50/50' : ''}`}
                                                            >
                                                                <td className="p-4 text-slate-400 font-mono">{index + 1}</td>
                                                                <td className="p-4 font-bold text-slate-800 text-lg">
                                                                    {row.value}
                                                                </td>
                                                                <td className="p-4 font-mono text-emerald-600 font-semibold">
                                                                    {row.ma} mA
                                                                </td>
                                                                <td className="p-4 font-mono text-slate-500">
                                                                    {row.percent}%
                                                                </td>
                                                                <td className="p-4">
                                                                    {index === 0 && <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-slate-200 text-slate-600">MIN</span>}
                                                                    {row.isClamped && <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-200 text-yellow-800">MAX (Clamp)</span>}
                                                                    {!row.isClamped && index === result.data.length -1 && <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-600">MAX</span>}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {/* Footer Message */}
                                            {result.data.length > 0 && result.data[result.data.length-1].isClamped && (
                                                <div className="p-3 bg-yellow-50 text-xs text-yellow-700 text-center border-t border-yellow-100">
                                                    ※ 자동 계산된 간격으로 나누어떨어지지 않아, 마지막 눈금은 최대값(Max)으로 강제 조정되었습니다.
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-300 p-12 border-2 border-dashed border-slate-200 rounded-xl">
                                        <IconSettings className="w-16 h-16 mb-4 opacity-20" />
                                        <p>좌측 패널에서 값을 입력하고 계산 버튼을 눌러주세요.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AutoScaleCalculator />);
    </script>
</body>
</html>